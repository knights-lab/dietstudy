---
title: "Targeted analysis of fiber from grains"
author: "Abby"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---
This is an R markdown document. Use the Knit button at the top of Rstudio to create figures and pdf reports of this document's contents. 

The goal of this document is to address the following hypothesis.

Hypothesis: Intake of fiber from grains is correlated with microbime beta diversity.

Plan to follow to test hypothesis:
1. Start with all the fiber data summarized for each person alreadly limited to just grains
2. Take this data and the food map and put it into qiime to get beta-diversity distance matrix
3. Plot pcoa



```{r setup, include=FALSE, message = FALSE}

# Add packages used in knitting this document here:
require(rmarkdown)
require(knitr)
require(ggplot2)
require(dplyr)
require(vegan)
require(ape)
require(tibble)


# Update this first path to be the root directory for this project on your computer
opts_knit$set(root.dir = "/Users/Abby/Documents/Projects/dietstudy/")

# This creates a figure directory in the same directory where this .Rmd document is located
# No need to change this code unless you want figures in different formats
opts_chunk$set(echo = TRUE, fig.path = "Figs/", dev = c("png", "pdf"), dpi = 300)

```


```{r load data, echo = FALSE}

# load the map example:
map <- read.table("data/maps/UserName_map.txt", sep = "\t", header = T, comment = "")

# load the fiber data
fiber <- read.table("data/processed_food/fiber.smry.otu.txt", sep = "\t", header = T, comment = "", stringsAsFactors = F)
#fiber <- fiber %>% select(-X.FoodID)

# remove soylents
fiber <- fiber %>% select(-c(MCTs11, MCTs12))
# remove bad data person
fiber <- fiber %>% select(-c(MCTs05))

# Do a little normalization
# Find and get median colsums
median_col <- median(colSums(fiber[,2:32]))
# Normalize and multiply by median_col
fiber[,2:32] <- sweep(fiber[,2:32], 2, colSums(fiber[,2:32]), "/")
fiber[,2:32] <- ceiling(fiber[,2:32] * median_col)

# Subset fiber to grains
grains <- fiber %>% slice(grep("L1_Grain", fiber$taxonomy))

# remove any grains with rowsums = 0
keep <- rowSums(grains[,2:32])>0
grains <- grains %>% filter(keep)

# export for use with QIIME
# Need X.FoodID column to be first column
# Need taxonomy to be last column
# Need X.FoodID to be "#FoodID" needs a # to work with QIIME
colnames(grains)[1] <- "#FoodID" 
write.table(grains, "data/processed_food/grains_fiber.txt", sep = "\t", row.names = F, quote = F)

```



```{r sub, echo = F, fig.height=7.5, fig.width=7.5}
# Import the beta diversity table from grains_beta (weighted or unweighted)
food_beta <- read.table(file="data/processed_food/grains_beta/unweighted_unifrac_grains_fiber.txt")

# refer this code to make a pcoa you will have to fix naming and play with the data structure of the dataframe called plot to get this to work.

#betad as matrix 
plot <- data.frame(pcoa(food_beta)$vectors)

# move rownames to a column
plot <- rownames_to_column(plot, var = "UserName")

#merge map and PCOA by SampleID - select both lines and run together - won't work otherwise
plot <- inner_join(plot, map, by = 'UserName')

Grain <- ggplot(plot, aes(x = Axis.1, y = Axis.2)) +
  geom_point(aes(fill = plot$UserName), alpha=1, pch = 21, size = 5) +
  scale_color_manual(values = c("black", "dark grey")) +
  #scale_shape_manual(values = shape_pal3) +
  labs(title="Uweighted Unifrac blah grains") +
  guides(fill = guide_legend(override.aes = list(alpha=1)), size = FALSE, col = FALSE) +
  #guides(size = FALSE, fill = FALSE) +
  theme_classic() +                                                                      
  theme(plot.title = element_text(size = 14, hjust = 0.5),
        legend.position = "none",
        legend.title = element_blank())

Grain

```

